function Robot(a,b,c,d){this.column=a,this.line=b,this.color=c,this.map=d,this.selected=!1,this.moved=!1,this.currentCell=d[b][a],this.currentCell.robot=this}Robot.prototype.setColumn=function(a){this.currentCell.robot=null,this.column=a,this.currentCell=this.map[this.line][a],this.currentCell.robot=this},Robot.prototype.setLine=function(a){this.currentCell.robot=null,this.line=a,this.currentCell=this.map[a][this.column],this.currentCell.robot=this},Robot.prototype.canMoveUp=function(){return!(0==this.line||1==this.currentCell.h||1==this.map[this.line-1][this.column].b||null!=this.map[this.line-1][this.column].robot)},Robot.prototype.canMoveDown=function(){return!(this.line==this.map.maxLine||1==this.currentCell.b||1==this.map[this.line+1][this.column].h||null!=this.map[this.line+1][this.column].robot)},Robot.prototype.canMoveLeft=function(){return!(0==this.column||1==this.currentCell.g||1==this.map[this.line][this.column-1].d||null!=this.map[this.line][this.column-1].robot)},Robot.prototype.canMoveRight=function(){return!(this.column==this.map.maxColumn||1==this.currentCell.d||1==this.map[this.line][this.column+1].g||null!=this.map[this.line][this.column+1].robot)},Robot.prototype.move=function(a){switch(a){case"UP":this.moveFn=this.moveUp;break;case"DOWN":this.moveFn=this.moveDown;break;case"RIGHT":this.moveFn=this.moveRight;break;case"LEFT":this.moveFn=this.moveLeft}for(var b=!1;this.moveFn();)this.moved=!0,b=!0;return b},Robot.prototype.moveLeft=function(){return this.canMoveLeft()?(this.setColumn(this.column-1),!0):!1},Robot.prototype.moveRight=function(){return this.canMoveRight()?(this.setColumn(this.column+1),!0):!1},Robot.prototype.moveDown=function(){return this.canMoveDown()?(this.setLine(this.line+1),!0):!1},Robot.prototype.moveUp=function(){return this.canMoveUp()?(this.setLine(this.line-1),!0):!1},Robot.prototype.isOnTarget=function(){return this.currentCell.target==this.color},Robot.prototype.canMove=function(a){return!(1==this.moved&&a!=this)};var commonModule=angular.module("commonModule",[]);commonModule.constant("HOST_URL",window.location.origin),commonModule.factory("socket",["$rootScope",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}]);var loggedApp=angular.module("loggedApp",["commonModule"]);loggedApp.factory("propositionService",["$http","gameInfo","HOST_URL",function(a,b,c){var d={};return d.proposition=[],d.sendProposition=function(){var e="login="+b.login+"&idGame="+b.idGame+"&proposition="+JSON.stringify(d.proposition);return a({url:c+"/proposition",method:"POST",data:encodeURI(e),headers:{"Content-Type":"application/x-www-form-urlencoded"}})},d.reset=function(){d.proposition=[]},d.doAction=function(a,b,c,e){var f={command:a};"select"==a?f.robot=b:(f.line=c,f.column=e),d.proposition.push(f)},d}]),loggedApp.factory("gameInfo",function(){var a={};return a.login=angular.element("#login").val(),a.idGame=angular.element("#idGame").val(),a}),loggedApp.controller("mainController",["$scope","socket","gameInfo","$timeout",function(a,b,c,d){b.emit("identification",{login:c.login,idGame:c.idGame}),a.firstFinder="Un joueur",a.player=c.login;var e=function(){a.countDown--,a.countDown>0&&d(e,1e3)};b.on("FinalCountDown",function(b){var c=b.FinalCountDown;a.countDown=c/1e3,e()}),b.on("TerminateGame",function(b){console.log("tg"),console.log(b),a.terminateGame=!0}),b.on("solutions",function(b){console.log("solution"),console.log(b),a.firstFinder=b.solutions[0].player})}]),loggedApp.controller("participantsController",["$scope","socket",function(a,b){a.participants=[],b.on("participants",function(b){a.participants=b.participants})}]),loggedApp.controller("mapController",["$scope","$http","gameInfo","HOST_URL","propositionService","$timeout",function(a,b,c,d,e,f){var g,h=function(){var a=angular.element("table"),b=a.width(),c=b/16-4;angular.element(".cell").height(c),robots=angular.element(".robot"),c-=4,robots.height(c),robots.width(c);var d=angular.element(".map-overlay");d.width(b),d.height(a.height())};window.onresize=h,b.get(d+"/"+c.idGame).success(function(a){g=JSON.parse(JSON.stringify(a)),i(a),f(h,200)}),a.gameName=c.idGame;var i=function(b){a.game={},a.game.map=b.board,a.game.map.maxLine=a.game.map.length,a.game.map.maxColumn=a.game.map[0].length;var c=b.robots.length;a.game.robots=[];for(var d=0;c>d;d++){var e=b.robots[d];a.game.robots.push(new Robot(e.column,e.line,e.color,a.game.map))}a.game.selectedRobot=null,a.game.lastRobotMoved=null;var f=b.target;a.game.map[f.l][f.c].target=f.t,a.gameStatus="Running"};a.reset=function(){e.reset();var a=JSON.parse(JSON.stringify(g));i(a),f(h,50)},a.selectRobot=function(b){a.$parent.terminateGame||a.game.selectedRobot==b||b.canMove(a.game.lastRobotMoved)&&(a.game.selectedRobot&&(a.game.selectedRobot.selected=!1),a.game.selectedRobot=b,b.selected=!0)},a.move=function(b){if(!a.$parent.terminateGame){var c=a.game.selectedRobot,d=c.moved;if(c&&c.canMove(a.game.lastRobotMoved)){var f=c.move(b,!0);if(f&&(a.game.lastRobotMoved=c,!d&&f&&e.doAction("select",c.color),e.doAction("move",null,c.line,c.column),c.isOnTarget())){var g=e.sendProposition();g.success(function(b){switch(console.log(b),b.state){case"SUCCESS":a.victory=!0,a.$parent.terminateGame=!0;break;case"TOO_LATE":a.tooLate=!0,a.$parent.terminateGame=!0;break;default:a.error=!0}}).error(function(){})}}}},a.$parent.keyPress=function(b){switch(b.which){case 40:a.move("DOWN");break;case 38:a.move("UP");break;case 37:a.move("LEFT");break;case 39:a.move("RIGHT");break;case 32:var c;if(a.game.selectedRobot){var d=a.game.robots.indexOf(a.game.selectedRobot),e=a.game.robots.length;for(d==e-1?d=0:d++;!a.game.robots[d].canMove(a.game.lastRobotMoved);)d==e-1&&(d=-1),d++;c=a.game.robots[d]}else c=a.game.robots[0];a.selectRobot(c)}}}]);