function Robot(a,b,c,d){this.column=a,this.line=b,this.color=c,this.map=d,this.cellsSelected=[],this.currentCell=d[b][a],this.currentCell.robot=this}function init(){socket=io.connect(),socket.on("gamesList",function(a){var b=document.getElementById("lesParties");b.innerHTML="";for(g in a.gamesList){var c=document.createElement("button");c.setAttribute("type","button"),c.classList.add("btn"),c.classList.add("btn-default"),c.onclick=function(){var b=a.gamesList[g];return function(){document.getElementById("idGame").value=b}}(),b.appendChild(c),c.appendChild(document.createTextNode(a.gamesList[g]))}}),socket.emit("loginPage")}Robot.prototype.selected=!1,Robot.prototype.moved=!1,Robot.prototype.upCell=null,Robot.prototype.downCell=null,Robot.prototype.rightCell=null,Robot.prototype.leftCell=null,Robot.prototype.setColumn=function(a){this.currentCell.robot=null,this.column=a,this.currentCell=this.map[this.line][a],this.currentCell.robot=this},Robot.prototype.setLine=function(a){this.currentCell.robot=null,this.line=a,this.currentCell=this.map[a][this.column],this.currentCell.robot=this},Robot.prototype.canMoveUp=function(a,b){return!(0===a||1==this.map[a][b].h||1==this.map[a-1][b].b||null!=this.map[a-1][b].robot)},Robot.prototype.canMoveDown=function(a,b){return!(a==this.map.maxLine||1==this.map[a][b].b||1==this.map[a+1][b].h||null!=this.map[a+1][b].robot)},Robot.prototype.canMoveLeft=function(a,b){return!(0===b||1==this.map[a][b].g||1==this.map[a][b-1].d||null!=this.map[a][b-1].robot)},Robot.prototype.canMoveRight=function(a,b){return!(b==this.map.maxColumn||1==this.map[a][b].d||1==this.map[a][b+1].g||null!=this.map[a][b+1].robot)},Robot.prototype.move=function(a){var b=!1;switch(a){case"UP":null!=this.upCell&&(this.setLine(this.upCell),b=!0);break;case"DOWN":null!=this.downCell&&(this.setLine(this.downCell),b=!0);break;case"RIGHT":null!=this.rightCell&&(this.setColumn(this.rightCell),b=!0);break;case"LEFT":null!=this.leftCell&&(this.setColumn(this.leftCell),b=!0)}return b&&(this.moved=!0,this.hideTrail(),this.showTrails()),b},Robot.prototype.isOnTarget=function(){return this.currentCell.target==this.color},Robot.prototype.canMove=function(a){return!(this.moved===!0&&a!=this)},Robot.prototype.unselect=function(){this.selected=!1,this.hideTrail()},Robot.prototype.select=function(){this.selected=!0,this.showTrails()},Robot.prototype.hideTrail=function(){for(var a=this.cellsSelected.length,b=0;a>b;b++)this.cellsSelected[b].endpoint=null,this.cellsSelected[b].trail=!1;this.cellsSelected=[]},Robot.prototype.showTrail=function(a,b,d,e){if(this.canMoveFn(this.line,this.column)){for(l=this.line+a,c=this.column+b;this.canMoveFn(l,c);)this.map[l][c].trail=!0,this.cellsSelected.push(this.map[l][c]),l+=a,c+=b;return this.cellsSelected.push(this.map[l][c]),this.map[l][c].endpoint=d,e===!0?l:c}return null},Robot.prototype.showTrails=function(){this.canMoveFn=this.canMoveUp,this.upCell=this.showTrail(-1,0,"UP",!0),this.canMoveFn=this.canMoveDown,this.downCell=this.showTrail(1,0,"DOWN",!0),this.canMoveFn=this.canMoveRight,this.rightCell=this.showTrail(0,1,"RIGHT",!1),this.canMoveFn=this.canMoveLeft,this.leftCell=this.showTrail(0,-1,"LEFT",!1)},Robot.prototype.reset=function(a,b){this.currentCell.robot=null,this.unselect(),this.moved=!1,this.line=b,this.column=a,this.currentCell=this.map[b][a],this.currentCell.robot=this},angular.module("loggedApp").factory("propositionService",["$http","HOST_URL","gameConstants",function(a,b,c){var d={};return d.proposition=[],d.sendProposition=function(){var e="login="+c.login+"&idGame="+c.idGame+"&proposition="+JSON.stringify(d.proposition);return a({url:b+"/proposition",method:"POST",data:encodeURI(e),headers:{"Content-Type":"application/x-www-form-urlencoded"}})},d.reset=function(){d.proposition=[]},d.doAction=function(a,b,c,e){var f={command:a};"select"==a?f.robot=b:(f.line=c,f.column=e),d.proposition.push(f)},d}]),angular.module("loggedApp").factory("game",["$http","HOST_URL","$timeout","propositionService","gameConstants",function(a,b,c,d,e){var f={};f.login=e.login,f.idGame=e.idGame,f.countDown=null;var g=function(){f.countDown--,f.countDown>0&&c(g,1e3)};f.startCountdown=function(a){f.finalCountDown=!0,f.countDown=a/1e3,g()},f.propositionDone=!1,f.terminateGame=!1,f.finishGame=function(){f.terminateGame=!0,f.countDown=0,f.isWinner=!1,f.participants.forEach(function(a){return 1==a.place?(f.isCurrentPlayerWinner=a.name==f.login,f.winner=a,void 0):void 0})};var h={};f.currentPlayer={name:f.login,place:"~",me:!0},h[f.login]=f.currentPlayer,f.participants=[h[f.login]],f.firstFinder="Un joueur",f.refreshRanks=function(a){a&&(f.firstFinder=a[0].player,a.forEach(function(b){var c=b.player;if(h[c]){var d=b.proposition.length,e=1;a.forEach(function(a){a.player!=c&&a.proposition.length<d&&e++}),h[c].place=e,h[c].nbCoups=d}}))},f.refreshParticipants=function(a){a.forEach(function(a){h[a]||(h[a]={name:a,place:"~",me:f.login==a,nbCoups:null},f.participants.push(h[a]))})};var i;f.selectedRobot=null,f.lastRobotMoved=null;var j=function(a,b){b!==!0&&(f.robots=[]);for(var c=a.length,d=0;c>d;d++){var e=a[d];b===!0?f.robots[d].reset(e.column,e.line):f.robots.push(new Robot(e.column,e.line,e.color,f.map))}f.selectedRobot=null,f.lastRobotMoved=null};return f.init=function(a){f.map=a.board;var b=a.board.length;f.map.maxLine=b;var c=a.board[0].length;f.map.maxColumn=c,i=JSON.parse(JSON.stringify(a.robots)),j(a.robots);var d=a.target;f.map[d.l][d.c].target=d.t},f.reset=function(){if(!f.terminateGame&&!f.propositionDone){d.reset();for(var a=f.robots.length,b=0;a>b;b++){var c=f.robots[b];c.moved===!0&&(f.map[c.line][c.column].robot=null)}var e=JSON.parse(JSON.stringify(i));j(e,!0)}},f.selectRobot=function(a){f.terminateGame||f.propositionDone||f.selectedRobot==a||a.canMove(f.lastRobotMoved)&&(f.selectedRobot&&f.selectedRobot.unselect(),f.selectedRobot=a,a.select())},f.move=function(a){if(!f.terminateGame&&!f.propositionDone){var b=f.selectedRobot,c=b.moved;if(b&&b.canMove(f.lastRobotMoved)){var e=b.move(a,!0);if(e&&(f.lastRobotMoved=b,!c&&e&&d.doAction("select",b.color),d.doAction("move",null,b.line,b.column),b.isOnTarget())){var g=d.sendProposition();g.success(function(a){switch(a.state){case"SUCCESS":f.propositionDone=!0;break;case"TOO_LATE":f.tooLate=!0,f.terminateGame=!0;break;default:f.error=!0}}).error(function(){})}}}},f.selectNext=function(){if(f.selectedRobot){var a=f.robots.indexOf(f.selectedRobot),b=f.robots.length;for(a==b-1?a=0:a++;!f.robots[a].canMove(f.lastRobotMoved);)a==b-1&&(a=-1),a++;f.selectRobot(f.robots[a])}else f.selectRobot(f.robots[0])},f}]),angular.module("loggedApp",["commonModule"]),angular.module("loggedApp").constant("gameConstants",{login:angular.element("#login").val(),idGame:angular.element("#idGame").val()}),angular.module("loggedApp").controller("mainController",["$scope","socket","game",function(a,b,c){b.emit("identification",{login:c.login,idGame:c.idGame}),a.game=c,b.on("FinalCountDown",function(a){c.startCountdown(a.FinalCountDown)}),b.on("TerminateGame",function(){c.finishGame()}),b.on("solutions",function(a){c.refreshRanks(a.solutions)}),b.on("participants",function(a){c.refreshParticipants(a.participants)}),a.keyPress=function(a){switch(a.preventDefault(),a.which){case 40:c.move("DOWN");break;case 38:c.move("UP");break;case 37:c.move("LEFT");break;case 39:c.move("RIGHT");break;case 32:c.selectNext();break;case 8:c.reset()}}}]),angular.module("loggedApp").directive("styleCellDirective",function(){return function(a,b){var c=a.cell,d=[];1==c.g&&d.push("cell-border-left "),1==c.d&&d.push("cell-border-right "),1==c.h&&d.push("cell-border-top "),1==c.b&&d.push("cell-border-bottom "),null!=c.target&&(d.push("target-"),d.push(c.target)),angular.element(b).addClass(d.join("")),a.$last&&window.onresize()}}),angular.module("loggedApp").controller("mapController",["$scope","$http","game","HOST_URL","propositionService","$timeout",function(a,b,c,d,e,f){a.game=c;var g=angular.element(".map-overlay"),h=angular.element("table"),i=null,j=function(){null===i&&(i=h.find("tr"));var a=h.width(),b=a/16-4;i.height(b),b-=4,f(function(){Robot.prototype.height=b,Robot.prototype.width=b}),g.width(a+4),g.height(h.height()+4)};window.onresize=j,b.get(d+"/"+c.idGame).success(function(a){c.init(a)}),a.clickCell=function(a){null!=a.endpoint&&c.move(a.endpoint)}}]);